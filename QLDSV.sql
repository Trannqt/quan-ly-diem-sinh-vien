CREATE DATABASE QLDSV
go

USE QLDSV
go

CREATE TABLE KHOA(
	MAKHOA VARCHAR(100), 
	TENKHOA NVARCHAR(100) CONSTRAINT K_TENKHOA_NN NOT NULL,
	NAMTHANHLAP INT,
	CONSTRAINT K_MAKHOA_PK PRIMARY KEY(MAKHOA)
)
go

CREATE TABLE LOP(
	MALOP VARCHAR(100) CONSTRAINT L_MALOP_PK PRIMARY KEY,
	TENLOP NVARCHAR(100) CONSTRAINT L_TENLOP_NN NOT NULL,
	SISO int,
	MAKHOA VARCHAR(100) CONSTRAINT L_MAKHOA_FK FOREIGN KEY REFERENCES KHOA(MAKHOA) ON DELETE CASCADE ON UPDATE CASCADE
)
go

CREATE TABLE SINHVIEN(
	MASV VARCHAR(100) CONSTRAINT SV_MASV_PK PRIMARY KEY,
	HOTEN NVARCHAR(100) CONSTRAINT SV_HOTEN_NN NOT NULL,
	NGAYSINH DATETIME CONSTRAINT SV_NGAYSINH_NN NOT NULL,
	GIOITINH NVARCHAR(5) CONSTRAINT SV_GIOITINH_C CHECK (GIOITINH IN (N'Nam',N'Nữ') ),
	DIACHI NVARCHAR(100) CONSTRAINT SV_DIACHI_NN NOT NULL,
	MALOP VARCHAR(100) CONSTRAINT SV_MALOP_FK FOREIGN KEY REFERENCES LOP(MALOP) ON DELETE CASCADE ON UPDATE CASCADE
)
GO

CREATE TABLE HOCPHAN(
	MAHP VARCHAR(100) CONSTRAINT PK_HOCPHAN PRIMARY KEY,
	TENHP NVARCHAR (100),
	TINCHI INT CONSTRAINT HP_TINCHI_NN NOT NULL,
	HOCKY INT CHECK(HOCKY<=3 AND HOCKY>=0),
	MAKHOA VARCHAR(100),
	PHANTRAMQT INT CHECK (PHANTRAMQT >=0 AND PHANTRAMQT <= 100),
	CONSTRAINT HP_MAKHOA_FK FOREIGN KEY(MAKHOA) REFERENCES KHOA ( MAKHOA ) ON DELETE CASCADE ON UPDATE CASCADE
)
GO

CREATE TABLE KETQUA
(
	MASV VARCHAR(100),
	MAHP VARCHAR(100),
	DIEMQT FLOAT NOT NULL CHECK (DIEMQT >=0 AND DIEMQT <=10),
	DIEMTHI FLOAT NOT NULL CHECK (DIEMTHI >= 0 AND DIEMTHI <= 10),
	DIEMTK FLOAT NOT NULL CHECK (DIEMTK >= 0 AND DIEMTK <= 10),
	KQ BIT,
	CONSTRAINT PK_MASV PRIMARY KEY (MASV,MAHP),
	CONSTRAINT FK_MASV FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT FK_MAHP FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP)
)
GO
create table TAIKHOAN (
TenTN NVARCHAR(100) primary key,
Pass NVARCHAR (100),
rights int)
GO

insert into TAIKHOAN Values
('admin','admin','9'), /*  admin panel  */
('4301104200','admin','0')

INSERT INTO KHOA VALUES
 ('VATLY',N'Vật Lý',1982),
 ('TOAN',N'Toán',1976),
 ('SINH',N'Sinh',1981),
 ('HOA',N'Hoá',1980),
 ('CNTT',N'Công nghệ thông tin',1990)
GO

INSERT INTO LOP 
VALUES
('43HOA',N'K43 SPH','50','HOA'),
('44SINH',N'K44 SPS','50','SINH'),
('43CNTT',N'K43 CNTT','50','CNTT'),
('41VLY',N'K41 VLY','50','VATLY'),
('42TOAN',N'K41 TOAN','50','TOAN')
GO
--
INSERT INTO SINHVIEN VALUES 
('4301104200',N'Nguyễn Văn Thành','1999-12-05 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104222',N'Nguyễn Thành','1998-12-08 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104185',N'Trần Tấn Đạt','1999-02-08 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104186',N'Trần Tấn Tạ','1999-02-28 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104187',N'Trần Đạt','1998-05-30 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104188',N'Trần Tấn','1999-01-18 00:00:00.000',N'Nam',N'TP.HCM','43HOA'),
('4301104189',N'Trần Tấn Được','1998-11-23 00:00:00.000',N'Nữ',N'TP.HCM','43HOA'),
('4302104685',N'Nguyễn Thị Thúy','1999-07-22 00:00:00.000',N'Nữ',N'TP.HCM','43CNTT'),
('4302104786',N'Trần Thị Tạ Uyên','1997-01-18 00:00:00.000',N'Nữ',N'TP.HCM','43CNTT'),
('4302104487',N'Bùi Thị Thu','1999-02-12 00:00:00.000',N'Nữ',N'TP.HCM','43CNTT'),
('4302104288',N'Trần Văn Tấn','1996-12-21 00:00:00.000',N'Nam',N'TP.HCM','43CNTT'),
('4302104839',N'Trần Không Được','1999-02-21 00:00:00.000',N'Nam',N'TP.HCM','43CNTT'),
('4402105685',N'Nguyễn Thị Thu Thúy','2000-09-08 00:00:00.000',N'Nữ',N'TP.HCM','44SINH'),
('4402102786',N'Trần Thị Uyên','2000-03-10 00:00:00.000',N'Nữ',N'TP.HCM','44SINH'),
('4402101487',N'Hồ Ngọc Thu','2010-12-26 00:00:00.000',N'Nữ',N'TP.HCM','44SINH'),
('4402104488',N'Trần Văn Hiếu','1999-10-21 00:00:00.000',N'Nam',N'TP.HCM','44SINH'),
('4402104339',N'Nguyễn Trí Nguyên','2000-07-07 00:00:00.000',N'Nam',N'TP.HCM','44SINH'),
('4102104185',N'Nguyễn Quang Trường','1997-12-28 00:00:00.000',N'Nam',N'TP.HCM','41VLY'),
('4102104286',N'Ngô Kiến Huy','1996-07-02 00:00:00.000',N'Nam',N'TP.HCM','41VLY'),
('4102104387',N'Đàm Vĩnh Hưng','1997-02-08 00:00:00.000',N'Nam',N'TP.HCM','41VLY'),
('4102104588',N'Duy Mạnh','1997-12-21 00:00:00.000',N'Nam',N'TP.HCM','41VLY'),
('4102104239',N'Hoàng Yến Chipi','1996-03-20 00:00:00.000',N'Nữ',N'TP.HCM','41VLY'),
('4202104785',N'Nguyễn Trấn Thành','1995-03-22 00:00:00.000',N'Nam',N'TP.HCM','42TOAN'),
('4202104886',N'Trần Thị Hương Giang','1998-12-03 00:00:00.000',N'Nữ',N'TP.HCM','42TOAN'),
('4202104387',N'Bùi Thị Thu Thủy','1998-02-26 00:00:00.000',N'Nữ',N'TP.HCM','42TOAN'),
('4202104288',N'Trần Trường Giang','1998-10-12 00:00:00.000',N'Nam',N'TP.HCM','42TOAN'),
('4202104139',N'Nguyễn Anh Đức','1997-02-21 00:00:00.000',N'Nam',N'TP.HCM','42TOAN')
GO


INSERT INTO HOCPHAN VALUES
 ('TH0001',N'Tin học đại cương A1','4','1','CNTT', 30),
 ('VL0001',N'Vật lý đại cương A1 ','5','1','VATLY', 40),
 ('VL0002',N'Vật lý đại cương A2 ','4','2','VATLY', 40),
 ('TH0002',N'Cấu trúc dữ liệu','3','1','CNTT', 40),
 ('HH0001',N'Hoá đại cương A1','5','1','HOA', 40),
 ('HH0002',N'Hoá đại cương A2','5','2','HOA', 40),
 ('TO0001',N'Toán rời rạc','3','1','TOAN', 30)
GO

INSERT INTO KETQUA( MASV,MAHP, DIEMQT, DIEMTHI, DIEMTK,KQ)
VALUES
('4301104200','TH0001',8.0, 9.6, 9.1, 1),
('4301104200','VL0001',1.0, 2.0, 1.6, 0),
('4301104200','VL0002',3.0, 3.6, 3.4, 0),
('4301104200','TH0002',5.0, 9.0, 7.4, 1),
('4301104200','HH0001',9.0, 4.6, 6.4, 1),
('4301104200','HH0002',5.5, 5.6, 5.6, 1),
('4301104200','TO0001',2.6, 1.6, 1.9, 0),
('4202104139','TH0001',9.9, 4.5, 6.1, 1),
('4202104886','TH0001',3.0, 2.4, 2.6, 0),
('4202104288','TH0001',7.0, 5.6, 6.0, 1),
('4102104239','TH0001',6.2, 5.0, 5.4,1),
('4102104588','VL0001',8.0, 6.7, 7.2,1),
('4102104185','HH0001',10.0, 4.0, 6.4,1),
('4302104839','TH0001',8.0, 7.8, 7.9, 1),
('4301104188','TH0001',8.0, 4.7, 5.7,1),
('4402105685','TH0001',5.5, 6.7, 6.3,1),
('4402102786','HH0001',6.4, 5.5, 5.9,1),
('4402104339','VL0001',7.9, 5.7, 6.6,1)
GO

INSERT INTO KETQUA (MASV,MAHP,DIEMQT, DIEMTHI, DIEMTK, KQ)
VALUES
('4301104185','TH0001',5.6, 5.5, 5.5,1),
('4301104186','TH0001',3.4, 3.0, 3.3,0),
('4301104187','TH0001',6.4, 5.0, 5.4,1),
('4301104189','TH0001',7.8, 6.9, 7.2,1),
('4302104685','TH0001',4.5, 9.0, 7.7,1),
('4302104786','VL0001',3.4, 2.0, 2.6,0),
('4302104487','VL0001',6.7, 5.0, 5.7,1),
('4302104288','HH0001',7.8, 7.8, 7.8,1),
('4402101487','TH0001',5.6, 7.8, 7.1,1),
('4402104488','TH0001',6.5, 8.0, 7.6,1),
('4102104286','TH0001',8.6, 8.0, 8.2,1),
('4102104387','VL0001',4.3, 8.0, 6.5,1),
('4202104785','VL0001',5.4, 8.0, 7.0,1),
('4202104387','TH0001',7.6, 8.0, 7.9,1)
GO

CREATE VIEW QLDIEMSV AS
SELECT S.MASV,S.HOTEN,H.MAHP,H.TENHP,K.DIEMQT,K.DIEMTHI,K.DIEMTK,K.KQ
FROM SINHVIEN S,  HOCPHAN H, KETQUA K
WHERE S.MASV = K.MASV AND H.MAHP=K.MAHP
GO

create view DSSV as
select h.TENHP, count(CASE When k.KQ = 1 THEN 1 END) as[DAU], count(CASE When k.KQ = 0 THEN 1 END) as[ROT]
from KETQUA k, HOCPHAN h
where h.MAHP=k.MAHP
group by h.TENHP
GO